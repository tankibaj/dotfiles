#!/usr/bin/env bash

aws_profile_list() {
  IFS=';' # https://en.wikipedia.org/wiki/Input_Field_Separators

  read -ra PROFILES <<< "$(aws configure list-profiles | tr '\n' ';')"
  
  local COUNT=1
  for i in ${PROFILES[@]}; do
    read -ra ITEMS <<< "${i}"
    echo "  ${COUNT}) ${ITEMS[0]}" >&2
    ((COUNT=COUNT+1))
  done

  local SELECT=0
  while [[ ${SELECT} -lt 1 || ${SELECT} -ge $COUNT ]]; do
    read -p "Pick an AWS profile: " SELECT >&2
  done

  echo "${PROFILES[(SELECT-1)]}"
}

get_eks_kubeconfig() {
  IFS=';' # https://en.wikipedia.org/wiki/Input_Field_Separators

  local PROFILE=$(aws_profile_list)
  read -ra CLUSTERS <<< "$(aws eks list-clusters --profile ${PROFILE} --output json | jq '.clusters[]' | tr -d '"' | tr '\n' ';')"

  local COUNT=1
  for i in ${CLUSTERS[@]}; do
    read -ra ITEMS <<< "${i}"
    echo "  ${COUNT}) ${ITEMS[0]}" >&2
    ((COUNT=COUNT+1))
  done

  local SELECT=0
  while [[ ${SELECT} -lt 1 || ${SELECT} -ge $COUNT ]]; do
    read -p "Pick an EKS cluster: " SELECT >&2
  done

  aws eks update-kubeconfig --name ${CLUSTERS[(SELECT-1)]} --profile ${PROFILE}
}

get_eks_kubeconfig